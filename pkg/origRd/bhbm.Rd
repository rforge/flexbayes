\name{bhbm}
\alias{bhbm}
\title{
  Bayesian Hierarchical Binomial Mixed Effects Model
}
\description{
Fit Bayesian hierarchical binomial mixed effects regression models.
 The models can optionally include overdispersion, and are written:

\code{    for j = 1, ..., J: the group index}

\code{    and i = 1, ..., n_j: the index for observations within group j,}

 \bold{No overdispersion case.}

\code{    counts_ij ~ Binomial( n_ij, theta_ij )  }

\code{    logit( theta_ij ) = X_ij beta_j + M_ij gamma  }\bold{:the link function}

\code{    beta_j = Z_j alpha + u_j   } \bold{:the random effects}

\code{    gamma ~ p( gamma )} \bold{:the fixed effects}

\code{    alpha ~ p( alpha )} \bold{:the second-level effects}

\code{  u_jk ~ N( 0, tau^2_k )  \bold{OR:}  u_j ~ N( 0, V )  }

\bold{ where}

\code{    counts_ij: data response (count) for the i-th case in the j-th group}

\code{    n_ij: number of trials for the i-th case in the j-th group}

\code{    X_ij: data predictors for the random effects of the i-th case in the j-th group}

\code{    M_ij: data predictors for the fixed effects of the i-th case in the j-th group}

\code{    Z_j: data predictors for the "population" or second-level effects in the j-th group}

\code{  The tau^2_k are given univariate priors or V is given an inverse Wishart prior.
  See \code{\link{bhbm.prior}} for details.}

\code{    The distribution p( gamma ) can be equal to N( gamma_0, V1_0 ) or t( df, gamma_0, V1_0 ), or 
  it can be flat (improper).  The same holds for p( alpha ). }


 \bold{Beta conjugate overdispersion.}

\code{    counts_ij ~ Binomial( n_ij, theta_ij )  }

\code{    theta_ij ~ Beta( xi_j mu_ij, xi_j ( 1 -  mu_ij ) ) }

\code{    logit( mu_ij ) = X_ij beta_j + M_ij gamma  }\bold{:the link function}

\code{    xi_j ~ Uniform Shrinkage( xi_0 )}

    and the rest of the hierarchy is as given above.


\bold{Logit-normal overdispersion.}

\code{     counts_ij ~ Binomial( n_ij, theta_ij )  }

\code{     logit( theta_ij )~ Normal(  mu_ij, sigma2_j ) }

\code{     mu_ij = X_ij beta_j + M_ij gamma   } \bold{:the link function }

\code{     sigma2_j ~ p( sigma2_j ): can be common for all groups; or known, etc. }

   and the rest of the hierarchy is as given above.


}
\usage{
bhbm( trials.formula=NULL, random.formula=NULL, 
  fixed.formula=NULL, level2.formula=NULL, 
  group.formula=NULL, data, 
  overdispersion="none", 
  prior=NULL, sampler=bhbm.sampler(), 
  random.seed=.Random.seed, na.action=na.fail, 
  contrasts=NULL )
}
\arguments{
\item{data}{
an object of class \code{data.frame} specifying the data.
}
\item{trials.formula }{
an object of class \code{formula} specifying the trials variable. This
variable should contain the number of trials associated with each observation.
}
\item{random.formula }{
an object of class \code{formula} specifying the random effects predictors
and optionally the outcome (counts) variable.  For instance,
\code{random.formula = Y ~ X1 + X2 - 1}
 indicates that the random effects predictors
are \code{X1} and \code{X2},
 that the intercept is not to be considered as a random effect, and that \code{Y} is 
 the outcome variable.  The outcome variable may be omitted, but then 
 it must be specified in \code{fixed.formula}.
}
\item{fixed.formula }{
an object of class \code{formula} specifying the fixed effects predictors
and optionally the outcome (counts) variable.  For instance,
\code{fixed.formula = Y ~ M1}, indicates that the intercept 
and \code{M1} are considered fixed effects predictors,
and that \code{Y} is the outcome variable.  The outcome variable may be omitted, but then 
 it must be specified in \code{random.formula}.
}
\item{level2.formula }{
an object of class \code{formula}
 specifying the second level effects predictors. These predictors
are assumed constant within groups, e.g. \code{level2.formula  = ~ 1}
specifies a common 
population mean model.
}
\item{group.formula }{
an object of class \code{formula}
 specifying the variable indicating the groups, e.g.
\code{group.formula = ~ School}
 indicates that the values of \code{School} correspond to 
 the groups, and that all those cases (observations) 
with the same \code{School} values are in the same group.
If \code{group.formula = NULL}, all of the observations
are taken to be in the same group.
}
\item{overdispersion }{
a string indicating whether and which type of overdispersion to use.
Acceptable values are \code{"none"}, \code{"beta-conj"}, and \code{"logit-normal"}.
If \code{ overdispersion = "none"}, then the first model above is fit.
If \code{ overdispersion = "beta-conj"} or \code{"logit-normal"} then the beta-conjugate 
or logit-normal overdispersion is used, respectively, as shown above.
}
\item{prior}{
a list generated by a call to \code{\link{bhbm.prior}}. The default is 
\code{bhbm.prior()} if \code{overdispersion = "none"}, 
is \code{bhbm.prior( xi = bayes.uniformShrinkage(0.5), common.glm = 2 )} if \code{overdispersion = "beta-conj"} and
is \code{bhbm.prior( sigma2 = bayes.uniformShrinkage(0.5), common.glm = 2 )} if \code{overdispersion = "logit-normal"}.
}
\item{sampler}{
a list generated by a call to \code{\link{bhbm.sampler}}. 
This list specifies
the MCMC control parameters such as the number of MCMC chains to be generated 
and the initial values to start the simulations.
}
\item{random.seed }{
an integer specifying the initial seed for the simulations.
}
\item{na.action }{
a flag that tells what to do with missing data. 
The default \code{na.action = na.fail} causes the program to
stop if any missing data is detected.
The other acceptable value of \code{na.action} is
\code{na.omit}.
}
\item{contrasts}{
argument to pass to a \code{model.matrix} call. This is 
relevant when some variables are factors.
}
}
\details{
The posterior distribution of the parameters of the model are estimated via Markov Chain
Monte Carlo simulation (a Metropolis-Hastings sampler is performed).
}
\section{References}{

Gelman, A., J. B. Carlin, H. S. Stern, and D. B. Rubin (2004). \emph{ Bayesian Data Analysis}, 2nd Edition. Boca Raton, Florida: Chapman & Hall.

Christiansen, C. L., and C. N. Morris, "Hierarchical Poisson regression modeling", \emph{J. American Statistical Association}, vol. 92, 438: 618-632, 1997.

Kass, R. E., and D. Steffey, "Approximate Bayesian inference in conditionally independent hierarchical models (parametric empirical Bayes models)", \emph{J. American Statistical Association}, vol. 84, 407: 717-726, 1989.
}
\seealso{
\code{\link{bhbm.prior}},
\code{\link{bhbm.sampler}},
\code{\link{bhpm}}.
}
\examples{
# Fit an overdispersed binomial model to the 
# toxoplasmosis data (Kass and Steffey 1989).
toxo.prior <- bhbm.prior( xi = 
  bayes.uniformShrinkage( 1 ), 
  random.var = bayes.invChisq( df=3, sigma0.sq=1 ),
  common.glm = 2 )

# Specify the control parameters (burn-in length, 
# etc.) and the initial values for the parameters.  
# The specification of an initial value for a
# fixed effect is required, but the value will be 
# ignored because no fixed effects are specified in 
# the call to bhbm.
toxo.sampler <- bhbm.sampler( nBurnin = 10000, 
  nSamples = 1000, nThin = 50, nChains = 1, 
  update.cov = 1, init.point = "user's choice", 
  params.init = list( xi = 10, random.coef = 0.5, 
  fixed.coef = 0, random.var = 1 ) )  

toxo.trials <- ~ ni
toxo.random <- yi ~ 1

##########################################
## call bhbm to fit a beta-conjugate model
toxo.bhbm <- bhbm( random.formula = toxo.random, 
  trials.formula = toxo.trials, data = toxo.dat, 
  overdispersion = "beta-conj", 
  prior = toxo.prior, sampler = toxo.sampler )

# check the convergence
autocorr.plot(toxo.bhbm)

# summarize the posterior distributions of the 
# parameters
summary(toxo.bhbm)
densplot(toxo.bhbm)
}
\keyword{Bayes}
